services:
  # Streamlit Admin Dashboard
  admin:
    build: .
    container_name: mybrain-admin
    ports:
      - "${ADMIN_PORT:-8501}:8501"
    volumes:
      - mybrain_data:/data/mybrain
    environment:
      - MYBRAIN_DATA_DIR=/data/mybrain
      - MYBRAIN_EMBEDDING_MODEL=${MYBRAIN_EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - MYBRAIN_CONFLICT_THRESHOLD=${MYBRAIN_CONFLICT_THRESHOLD:-0.5}
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8501/_stcore/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # MCP Server (for CLI/stdio usage - run manually when needed)
  # Usage: docker compose run --rm mcp-server
  mcp-server:
    build: .
    container_name: mybrain-mcp
    healthcheck:
      test: [ "NONE" ]
    volumes:
      - mybrain_data:/data/mybrain
    environment:
      - MYBRAIN_DATA_DIR=/data/mybrain
      - MYBRAIN_EMBEDDING_MODEL=${MYBRAIN_EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - MYBRAIN_CONFLICT_THRESHOLD=${MYBRAIN_CONFLICT_THRESHOLD:-0.5}
    stdin_open: true
    tty: true
    command: [ "python", "server.py" ]
    profiles:
      - mcp # Only start with: docker compose --profile mcp up

volumes:
  mybrain_data:
    driver: local
